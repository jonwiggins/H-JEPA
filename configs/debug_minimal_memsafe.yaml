# Debug configuration with minimal parameters and memory safety for MPS
# Ultra-small configuration for testing and debugging on Apple Silicon

# Experiment settings
experiment:
  name: "debug_minimal_memsafe"
  seed: 42
  output_dir: "results/debug_minimal_memsafe"

# Model configuration
model:
  encoder_type: "vit_base_patch16_224"
  img_size: 224
  num_hierarchies: 3
  embed_dim: 768
  use_fpn: true
  fpn_channels: 256
  use_rope: true
  rope_theta: 10000.0
  use_flash_attention: false  # Disabled for MPS
  use_mps_optimization: true  # Enable MPS optimizations
  use_layerscale: false
  layerscale_init: 1e-5
  predictor_depth: 4
  predictor_mlp_ratio: 4.0
  predictor_use_norm: true

# Data configuration
data:
  dataset: "cifar10"
  data_path: "./data"
  batch_size: 4  # Reduced from 8 to prevent OOM
  num_workers: 2  # Reduced workers
  image_size: 224
  transforms:
    train:
      RandomResizedCrop:
        size: 224
        scale: [0.4, 1.0]
      RandomHorizontalFlip:
        p: 0.5
      Normalize:
        mean: [0.485, 0.456, 0.406]
        std: [0.229, 0.224, 0.225]
    val:
      Resize:
        size: 256
      CenterCrop:
        size: 224
      Normalize:
        mean: [0.485, 0.456, 0.406]
        std: [0.229, 0.224, 0.225]

# Masking configuration
masking:
  num_target_masks: 2  # Minimal masks
  target_mask_scale: [0.15, 0.2]
  target_aspect_ratio: [0.75, 1.5]
  num_context_masks: 1
  context_mask_scale: [0.85, 1.0]
  hierarchical_masking: true
  mask_at_levels: [1, 2, 3]
  mask_overlap_threshold: 0.0

# Loss configuration
loss:
  type: "smoothl1"  # Simple loss for debugging
  smoothl1_beta: 0.01
  hierarchy_weights: [1.0, 0.7, 0.5]
  use_vicreg: false  # Disabled to reduce memory
  use_sigreg: false  # Disabled to reduce memory

# Training configuration
training:
  epochs: 3  # Minimal epochs
  warmup_epochs: 1
  learning_rate: 0.0005
  lr: 0.0005  # Duplicate for compatibility
  weight_decay: 0.04
  betas: [0.9, 0.95]
  eps: 1.0e-8
  optimizer: "adamw"
  scheduler: "cosine"
  lr_schedule: "cosine"  # Duplicate for compatibility
  scheduler_params:
    min_lr: 1.0e-6
  gradient_clip: 1.0
  use_amp: false  # Disabled for MPS
  use_gradient_checkpointing: false  # Can cause memory issues
  use_compile: false
  accumulation_steps: 1  # No gradient accumulation
  ema_momentum_schedule:
    start: 0.996
    end: 1.0
    warmup_steps: 1000
  # Memory management
  clear_cuda_cache_freq: 10  # Clear cache every 10 steps

# Logging configuration
logging:
  log_frequency: 10
  save_frequency: 1000  # Save less frequently
  use_wandb: false
  use_tensorboard: true
  log_images: false  # Disable to save memory
  log_gradients: false  # Disable to save memory
  log_memory: true  # Enable memory logging

# Evaluation configuration
evaluation:
  eval_frequency: 1000  # Eval less frequently
  eval_linear_probe: false
  eval_knn: false

# Device configuration
device: "mps"

# Checkpointing
checkpoint:
  save_best: false  # Disable to save memory
  save_last: true
  max_checkpoints: 1  # Minimal checkpoints
  metric: "train_loss"
  mode: "min"
